PLATFORM: linux

image_resource:
  type: docker-image
  source:
    repository: pivotaldata/centos-gpdb-dev
    tag: '6-gcc6.2-llvm3.7'

inputs:
- name: gpbackup
  path: go/src/github.com/greenplum-db/gpbackup
- name: ccp_src
- name: cluster_env_files
- name: gpdb_src
- name: sqldump
- name: backup_artifact

run:
  path: bash
  args:
  - -c
  - |
    set -ex

    ccp_src/scripts/setup_ssh_to_cluster.sh
    cp -r backup_artifact/* /tmp

    pushd /tmp
      tar -zxf backup_artifact.tar.gz
      scp gpbackup_allsegments/gpbackup_mdw.tar.gz mdw:/tmp
      scp gpbackup_allsegments/gpbackup_sdw1.tar.gz sdw1:/tmp
    popd
    ssh -t sdw1 'pushd /tmp ; tar -xzf gpbackup_sdw1.tar.gz ; popd'

    # (2) Generate & run script to restore the backedup data to a new cluster and generate a pg_dump
    cat <<SCRIPT > /tmp/gprestore_and_dump.bash
        set -ex
        source env.sh

        # extract backup tarball 
        pushd /tmp
          tar -xzf gpbackup_mdw.tar.gz
          ls backup_artifact/ | sort -g > /tmp/db_indices
          
          # for each DB, find the timestamp & restore
          while read db_index ; do
            [ -z "\${db_index}" ] && continue
            find ./backup_artifact/\${db_index} -name "*_metadata.sql" | sed -nr 's#.*gpseg-[0-9]/backups/.*/([0-9]{14})/.*#\1#p' > /tmp/\${db_index}_timestamp
            read timestamp < /tmp/\${db_index}_timestamp
            echo "\${db_index} timestamp: \${timestamp}"

            echo "##### Restore backup artifact for \${db_index} DB #####"
            gprestore --create-db --timestamp \${timestamp} --backup-dir /tmp/backup_artifact/\${db_index} --with-globals
          done < /tmp/db_indices

        popd

        echo "##### pg_dumpall #####"
        #pg_dumpall -f /tmp/final_dump.sql
        #xz -z /tmp/final_dump.sql
    SCRIPT

    chmod +x /tmp/gprestore_and_dump.bash
    scp /tmp/gprestore_and_dump.bash mdw:/home/gpadmin/gprestore_and_dump.bash
    ssh -t mdw "bash /home/gpadmin/gprestore_and_dump.bash"
    
    scp mdw:/tmp/final_dump.sql.xz /tmp/

    # (3) Compare sqldump resource and the pg_dump that was newly generated

    #xz -d sqldump/dump.sql.xz
    #xz -d /tmp/final_dump.sql.xz
    #output=$(diff sqldump/dump.sql /tmp/final_dump.sql)
    #retval=$?
    #if [ "${retval}" != "0" ] ; then
    #  echo "${output}"
    #  exit 1
    #fi


